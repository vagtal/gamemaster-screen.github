import{at as b,P as B,aJ as A,C as r,y as p,Q as y,I,aK as R,m as u,L as v,R as D,u as x,w as P,b as w,F as T,aL as U}from"./FirebaseUtils-DPMbTUBM.js";import{r as E,j as h}from"./index-B5q0XL7m.js";import{G as L,R as k}from"./RollTableCard-Ds6vctU6.js";function F(e,a,l,i){const n={cardId:e,playerViewPermission:B.Visible,title:b[a],campaignId:i};if(l.includes(n.title)){let o=2;for(;l.includes(n.title+" "+o);)o++;n.title+=" "+o}return a==="clock"?{...n,type:a,value:0,max:6}:a==="roll-table-h"?{...n,type:a,rollHistory:[],entries:[{weight:3,content:"Miss"},{weight:2,content:"Partial"},{weight:1,content:"Success"}]}:a==="image"?{...n,type:a,imageUrl:""}:a==="dice"?{...n,type:a,history:[]}:a==="drawing"?{...n,type:a}:a==="pdf"?{...n,type:a,pdfUrl:"",currentPage:1}:a==="ledger"?{...n,type:a,entries:[],units:"",isDecreasing:!1}:a==="frame"?{...n,type:a,frameUrl:""}:{...n,type:"article",content:""}}function s(e,a,l){const i=a.payload.cardId,n=e[i];return n?{...e,[i]:{...n,...l}}:e}const V=A({}).handleAction(r.SetCardContent,(e,a)=>s(e,a,{content:a.payload.content})).handleAction(r.SetCardTitle,(e,a)=>s(e,a,{title:a.payload.title})).handleAction(r.SetCardPath,(e,a)=>s(e,a,{path:a.payload.path})).handleAction(r.SetPlayerViewPermission,(e,a)=>s(e,a,{playerViewPermission:a.payload.playerViewPermission})).handleAction(r.SetThemeColor,(e,a)=>s(e,a,{themeColor:a.payload.themeColor})).handleAction(r.SetCustomColor,(e,a)=>s(e,a,{themeColor:"custom",customColor:a.payload.customColor})).handleAction(r.SetCardCampaign,(e,a)=>s(e,a,{campaignId:a.payload.campaignId})).handleAction(r.SetClockValue,(e,a)=>s(e,a,{value:a.payload.value})).handleAction(r.SetClockMax,(e,a)=>s(e,a,{max:a.payload.max})).handleAction(r.SetClockDetail,(e,a)=>{const i=(e[a.payload.cardId].details||[]).slice();return i[a.payload.detailIndex]=a.payload.detail,s(e,a,{details:i})}).handleAction(r.SetClockDisplayType,(e,a)=>s(e,a,{displayType:a.payload.displayType})).handleAction(r.SetRollTableEntries,(e,a)=>s(e,a,{entries:a.payload.entries})).handleAction(r.PushRollTableHistory,(e,a)=>{const l=e[a.payload.cardId];return s(e,a,{rollHistory:[...l.rollHistory||[],a.payload.rollResult]})}).handleAction(r.SetImageUrl,(e,a)=>s(e,a,{imageUrl:a.payload.imageUrl})).handleAction(r.RollDiceExpression,(e,a)=>{const l=e[a.payload.cardId],{cardId:i,...n}=a.payload;return s(e,a,{history:(l.history||[]).concat([n])})}).handleAction(r.SetQuickRolls,(e,a)=>s(e,a,{quickRolls:a.payload.quickRolls})).handleAction(r.RevertToDefaultQuickRolls,(e,a)=>s(e,a,{quickRolls:void 0})).handleAction(r.SetShowHistoryLength,(e,a)=>s(e,a,{showHistoryLength:a.payload.unlimited?void 0:a.payload.showHistoryLength})).handleAction(r.SetSceneElements,(e,a)=>s(e,a,{sceneElementJSONs:a.payload.sceneElementJSONs})).handleAction(r.SetPDF,(e,a)=>{const l=e[a.payload.cardId];return l?s(e,a,{pdfUrl:a.payload.pdfURL,currentPage:1,title:e.pdfUrl?a.payload.pdfTitle:l.title}):e}).handleAction(r.SetPDFPage,(e,a)=>s(e,a,{currentPage:a.payload.page})).handleAction(r.AddLedgerEntry,(e,a)=>{const l=e[a.payload.cardId];return s(e,a,{entries:[...l.entries||[],{changeAmount:a.payload.changeAmount,comment:a.payload.comment}]})}).handleAction(r.RemoveLedgerEntry,(e,a)=>{const l=e[a.payload.cardId];return s(e,a,{entries:(l.entries||[]).filter((i,n)=>n!==a.payload.ledgerEntryIndex)})}).handleAction(r.SetLedgerUnits,(e,a)=>s(e,a,{units:a.payload.units})).handleAction(r.SetLedgerDecreasing,(e,a)=>s(e,a,{isDecreasing:a.payload.isDecreasing})).handleAction(r.SetFrameUrl,(e,a)=>s(e,a,{frameUrl:a.payload.frameUrl}));function O(e,a){var n,o;if(p(y.SetUserClaims,a)){const d={...e,user:{isLoggedIn:!0,hasStorage:!0,hasEpic:!0}};return a.payload.hasEpic||(d.activeCampaignId=void 0),d}if(p(y.LogOut,a))return{...e,user:{isLoggedIn:!0,hasStorage:!0,hasEpic:!0},activeCampaignId:void 0};if(p(I.UpdateDashboardFromServer,a))return{...e,dashboardsById:{...e.dashboardsById,[a.payload.dashboardId]:{name:"",openCardIds:[],layoutsBySize:a.payload.dashboardState.layoutsBySize||{xxl:a.payload.dashboardState.layouts||[]},layoutCompaction:"free",layoutPushCards:"none",...a.payload.dashboardState}}};if(p(r.UpdateCardFromServer,a))return{...e,cardsById:{...e.cardsById,[a.payload.cardId]:R(a.payload.cardState)}};if(p(y.UpdateCampaignFromServer,a))return a.payload.campaignState.id?{...e,campaignsById:{...e.campaignsById,[a.payload.campaignState.id]:a.payload.campaignState}}:e;if(p(I.CreateDashboard,a)){let d=0,t;const m=c=>c.name===t;do d+=1,t="Dashboard "+d;while(Object.values(e.dashboardsById).some(m));return{...e,dashboardsById:{...e.dashboardsById,[a.payload.dashboardId]:{name:t,layoutCompaction:"free",layoutPushCards:"none",openCardIds:[],layoutsBySize:{xxl:[]},campaignId:e.activeCampaignId}}}}if(p(I.DeleteDashboard,a)){const d=u.omit(e.dashboardsById,a.payload.dashboardId);return{...e,dashboardsById:d}}const l={...e.dashboardsById},i=a;if(i.payload.dashboardId){const d=e.dashboardsById[i.payload.dashboardId];d&&(l[i.payload.dashboardId]=v(d,i))}if(p(I.AddCard,a)){const d=a.payload.cardId,t=(n=l[a.payload.dashboardId])==null?void 0:n.campaignId;return{...e,cardsById:{...e.cardsById,[d]:F(d,a.payload.cardType,Object.values(e.cardsById).map(m=>m.title),t)},dashboardsById:l}}if(p(I.AddCardFromTemplate,a)){const d=u.cloneDeep(e.templatesById[a.payload.templateId]);if(!d)return e;let t=d.title,m=1;const c=Object.values(e.cardsById).map(f=>f.title);for(;c.includes(t);)t=`${d.title} ${++m}`;const g=(o=l[a.payload.dashboardId])==null?void 0:o.campaignId,C={...d,cardId:a.payload.cardId,title:t,campaignId:g};return{...e,cardsById:{...e.cardsById,[a.payload.cardId]:C},dashboardsById:l}}if(p(r.DeleteCard,a))return{...e,cardsById:u.omit(e.cardsById,a.payload.cardId),dashboardsById:u.mapValues(e.dashboardsById,d=>{const t=d.openCardIds??[];return{...d,openCardIds:t.filter(m=>m!==a.payload.cardId)}})};if(p(y.CreateTemplateFromCard,a)){const d=u.cloneDeep(e.cardsById[a.payload.cardId]);if(!d)return e;const t={...d,cardId:a.payload.templateId};return{...e,templatesById:{...e.templatesById,[a.payload.templateId]:t},appSettings:{...e.appSettings,templateIdsInMenu:[...e.appSettings.templateIdsInMenu,a.payload.templateId]}}}if(p(y.DeleteTemplate,a))return{...e,templatesById:u.omit(e.templatesById,a.payload.templateId),appSettings:{...e.appSettings,templateIdsInMenu:u.without(e.appSettings.templateIdsInMenu,a.payload.templateId)}};if(p(y.CreateCampaign,a))return{...e,campaignsById:{...e.campaignsById,[a.payload.campaignId]:{id:a.payload.campaignId,title:a.payload.title}}};if(p(y.SetCampaignActive,a))return{...e,activeCampaignId:a.payload.campaignId};if(p(y.RenameCampaign,a))return{...e,campaignsById:{...e.campaignsById,[a.payload.campaignId]:{id:a.payload.campaignId,title:a.payload.title}}};if(p(y.DeleteCampaign,a)){let d=e.activeCampaignId;return d===a.payload.campaignId&&(d=void 0),{...e,activeCampaignId:d,campaignsById:u.omit(e.campaignsById,a.payload.campaignId),cardsById:u.mapValues(e.cardsById,t=>({...t,campaignId:void 0})),dashboardsById:u.mapValues(e.dashboardsById,t=>({...t,campaignId:void 0}))}}return p(y.SetSettings,a)?{...e,appSettings:{...e.appSettings,...a.payload.settingsPartial}}:p(y.ImportCardsAndDashboards,a)?{...e,dashboardsById:{...e.dashboardsById,...a.payload.dashboardsById},cardsById:{...e.cardsById,...a.payload.cardsById},campaignsById:{...e.campaignsById,...a.payload.campaignsById}}:{...e,cardsById:V(e.cardsById,a),dashboardsById:l}}function N(){const{state:e,dispatch:a}=E.useContext(D),l=x(),i=P(e,l),n=d=>d.type==="roll-table-h",o=i.filter(n)||[];return(o==null?void 0:o.length)<2?null:h.jsx(w,{tip:"Roll on all Table Cards",icon:h.jsx(T,{icon:U}),onClick:()=>{for(const d of o){const t=L(d,0);a(r.PushRollTableHistory({cardId:d.cardId,rollResult:k(t.dieSize)}))}}})}export{O as A,N as R};
