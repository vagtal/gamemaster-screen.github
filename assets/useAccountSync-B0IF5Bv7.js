import{g as h,s as C,o as v,b as $}from"./index-e3d5d3f4-JPXBnBl4.js";import{r as d,a as p}from"./index-0mFGPIzu.js";import{V as E,h as L,m as I,k as y,g as S,r as g,s as T,z as _,o as B,d as A,Q as F,I as N,C as D}from"./FirebaseUtils-Bz9HKAc4.js";const O={},R=O;function Y(e,t,o){if(!R.VITE_ENABLE_ACCOUNT_SYNC)return;const[a,s]=d.useState(!1);x(e,t,()=>s(!0),o),z(e,t,a)}const k=(e,t)=>{try{const o=parseInt(e||"",10);return isNaN(o)?t:o}catch{return t}};function x(e,t,o,a){const s=d.useRef(null);d.useEffect(()=>{if(s.current)return;const n=h(p);s.current=v(n,async c=>{if(!c){o();return}const u=parseInt(localStorage.getItem("localLastUpdateTime")||"0");if(isNaN(u)){localStorage.setItem("localLastUpdateTime","0"),o();return}const l=S(p),i=g(l,`users/${c.uid}`);B(i,async m=>{A(i);const r=m.val();k(r==null?void 0:r.lastUpdateTime,0)<=u?j(e,r,c.uid):r!==null&&q(e,t,r),a([...Object.keys(e.dashboardsById),...Object.keys((r==null?void 0:r.dashboardsById)??{})]);const f=Date.now().toString();localStorage.setItem("localLastUpdateTime",f);const w=g(l,`users/${c.uid}/lastUpdateTime`);await T(w,f),o()})})},[e,t,o,a])}const U=["cardsById","dashboardsById","campaignsById"],V={cardsById:(e,t)=>D.UpdateCardFromServer({cardId:e,cardState:t}),dashboardsById:(e,t)=>N.UpdateDashboardFromServer({dashboardId:e,dashboardState:t}),campaignsById:(e,t)=>F.UpdateCampaignFromServer({campaignState:t})};function j(e,t,o){var a;console.log("Local data is newer, writing to DB");for(const s of U)for(const n in e[s])if(!I.isEqual(e[s][n],(a=t==null?void 0:t[s])==null?void 0:a[n])){const c=y.removeUndefinedNodesFromTree(e[s][n]),u=S(p),l=g(u,`users/${o}/${s}/${n}`);T(l,c)}}function q(e,t,o){console.log("Server data is newer, writing to local");for(const a of U)for(const s in o[a])I.isEqual(e[a][s],o[a][s])||t(V[a](s,o[a][s]))}function z(e,t,o){const a=d.useRef(e),s=G();d.useEffect(()=>{if(!(!o||!s||!e.user.hasStorage)){for(const n of U){const c=e[n],u=a.current[n],l=I.union(Object.keys(c),Object.keys(u));for(const i of l){const m=y.removeUndefinedNodesFromTree(c[i]),r=y.removeUndefinedNodesFromTree(u[i]);if(!I.isEqual(m,r)){const b=S(p),f=g(b,`users/${s}/${n}/${i}`);m?(console.log(`Updating ${n}/${i} on server`),T(f,m)):(console.log(`Deleting ${n}/${i} on server`),_(f))}}}a.current=e}},[e,t,s,o])}function G(){const[e,t]=d.useState(null),o=d.useContext(E);return d.useEffect(()=>{if(o!==L.GameMaster)return;const a=h(p);C(a,$).then(()=>{v(a,async s=>{if(!s){console.log("received empty user from onAuthStateChanged");return}t(s.uid)})})},[t,o]),e}export{Y as a,G as u};
