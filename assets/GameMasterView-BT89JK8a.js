import{r as l,a as f,u as S,j as c}from"./index-B5q0XL7m.js";import"./index-e3d5d3f4-BnpCz8AB.js";import{A as x}from"./RollAllTablesButton-D_dykPNe.js";import{u as g,g as y,r as m,s as b,t as B,d as A,k as D,v,G as R,w as j,P as w,_ as C,x as E,y as P,C as o,z as V,A as T,I,J as L,q as U,R as k,K as $,i as G,j as M,B as F,U as O}from"./FirebaseUtils-DPMbTUBM.js";import{u as H,C as N}from"./usePageTitle-2QUgLn3-.js";import{u as z,a as J}from"./useAccountSync-DDLkXJ2F.js";import{u as _,T as q,L as K,A as Q}from"./AppSettings-BPHPQO6a.js";import"./tslib.es6-CDuPK5Eb.js";import"./RollTableCard-Ds6vctU6.js";import"./TextArea-DxqCdVca.js";import"./useScrollTo-C5qbPxSc.js";import"./LongPressButton-BsvFwpmp.js";import"./Anchor-DTLE72rf.js";import"./CheckBoxGroup-Cbq_q2Ee.js";import"./cards-regular-lblrVrU_.js";function W(s,a){if(a==null)return{...s,cardsById:{}};const d=R(s,a);if(!d)return{...s,cardsById:{},dashboardsById:{}};const e=j(s,a).filter(r=>r.playerViewPermission!==w.Hidden)||[],t=e.map(r=>r.cardId);return{...s,cardsById:E(s.cardsById,(r,i)=>e.some(u=>u.cardId===i)),dashboardsById:{[a]:{...d,openCardIds:t,layoutsBySize:C.mapValues(d.layoutsBySize,r=>r.filter(i=>t.includes(i.i)))}}}}function X(s,a){const d=l.useRef(s),e=z(),t=g();l.useEffect(()=>{if(!e)return;const r=y(f),i=m(r,`ownerByDashboardId/${t}`);b(i,e);const u=m(r,`pendingActions/${t}`);return B(u,p=>{const n=p.val();P([o.SetCardContent,o.RollDiceExpression,o.SetImageUrl,o.PushRollTableHistory,o.SetRollTableEntries,o.SetClockValue,o.SetClockMax,o.SetClockDisplayType,o.AddLedgerEntry,o.RemoveLedgerEntry,o.SetLedgerUnits,o.SetLedgerDecreasing,o.SetSceneElements,o.SetPDF],n)?a(n):console.warn("Action not permitted in Player View: ",n.type),V(p.ref)}),()=>A(u)},[e,t,a]),l.useEffect(()=>{if(!e||!t)return;const r=W(D.removeUndefinedNodesFromTree(s),t);if(JSON.stringify(d.current)!==JSON.stringify(r)){const i=y(f),u=m(i,`users/${e}/playerViews/${t}`);b(u,r),d.current=r}},[s,e,t]),l.useEffect(()=>{if(!e)return;const r=y(f),i=m(r,`status/${e}`);b(i,"online"),v(i).set("offline")},[e])}function me(){const[s,a]=T(x,O,"appState"),d=S();_(a),X(s,a);const e=g();H(s),l.useEffect(()=>{e&&a(I.ActivateDashboard({dashboardId:e,currentTimeMs:Date.now()}))},[e,a]);const t=L(),r=l.useCallback(i=>{if(!e){const p=C.sortBy(Object.keys(s.dashboardsById),n=>{var h;return-(((h=s.dashboardsById[n])==null?void 0:h.lastOpenedTimeMs)||0)})[0];if(p)d.replace(`/e/${p}`);else{const n=U();a(I.CreateDashboard({dashboardId:n})),d.replace(`/e/${n}`)}return}i.includes(e)||d.replace(`/d/${e}`)},[e,a,d,s.dashboardsById]);return J(s,a,r),c.jsx(k.Provider,{value:{state:s,dispatch:a},children:c.jsx($.Provider,{value:t,children:c.jsx(G,{style:{minHeight:"100%"},theme:M,children:c.jsxs(F,{fill:!0,align:"center",children:[c.jsx(q,{}),c.jsx(N,{}),t.librarySidebarMode!=="hidden"&&c.jsx(K,{}),t.appSettingsVisible&&c.jsx(Q,{})]})})})})}export{me as default};
